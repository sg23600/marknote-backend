let express,Notes;_b10‍.w("express",[["default",["express"],function(v){express=v}]]);_b10‍.w("../models/Notes",[["default",["Notes"],function(v){Notes=v}]]);


const route = express.Router()
// req => {obj, gId}

// route.get("/", async (req, res) => {
//   await Notes.find({}, (err, doc) => {
//     return res.json(doc)
//   })
// })

route.post("/", async (req, res) => {
  await Notes.findOne({ googleId: req.body.googleId }, (err, doc) => {
    if (doc) {
      _b10‍.g.console.log(doc.notes)
      return res.json(doc.notes)
    }
  })
})

route.post("/new", async (req, res) => {
  await Notes.findOne({ googleId: req.body.googleId }, async (err, doc) => {
    if (doc.notes.length === 0) {
      // first note
      doc.notes.push({
        id: 1,
        title: req.body.title,
        body: req.body.body,
        // private: req.body.private,
      })
      doc.save()
      return res.json(doc)
    } else {
      let newId = Math.max.apply(
        Math,
        doc.notes.map((o) => {
          return o.id
        })
      ) // largest ID number

      doc.notes.push({
        id: newId + 1,
        title: req.body.title,
        body: req.body.body,
        // private: req.body.private,
      })
      doc.save()
      return res.json(doc)
    }
  }).exec()
})

route.post("/edit", async (req, res) => {
  _b10‍.g.console.log("Edit \n", req.body)
  await Notes.findOne({ googleId: req.body.googleId }, (err, doc) => {
    if (doc) {
      for (let i = 0; i < doc.notes.length; i++) {
        if (doc.notes[i].id === req.body.id) {
          console.log("note found!")
          doc.notes[i].title = req.body.title
          doc.notes[i].body = req.body.body
        }
      }
      doc.markModified("notes")
      doc.save()

      return res.json(doc)
    } else res.json("Not found")
  }).exec()
})

route.post("/delete", async (req, res) => {
  await Notes.find({ googleId: req.body.googleId }, (err, doc) => {
    if (doc) {
      const len = doc.notes.length;
      for (let i = 0; i < len; i++) {
        if (doc.notes[i].id === req.body.id) {
          console.log("note found")
          // doc.notes.splice(i, 1)
          doc.markModified("notes")
          doc.save()

          return res.json(doc)
        }
      }
    } else res.json("Not found")
  })
})

module.exports = route
